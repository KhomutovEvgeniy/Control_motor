/***************************************************************************************************
Описание: Файл для управления скоростью двигателя на основе ПИД-регулятора
Разработчик: Хомутов Евгений
Заметки:
***************************************************************************************************/
#include "control.h"   
#include <stdlib.h>
#include <stm32f10x_gpio.h>
#include <stm32f10x_rcc.h>
#include <stm32f10x_tim.h>


/***************************************************************************************************
Локальные дефайны
***************************************************************************************************/

/***************************************************************************************************
Локальные типы данных
***************************************************************************************************/

/***************************************************************************************************
Локальные переменные файла
***************************************************************************************************/
// Коэффициенты усиления ПИД-регулятора
static float kP = 20;
static float kI = 1;
static float kD = 0.5;

static uint16_t prevErr = 0;
static uint16_t intTerm = 0;

/***************************************************************************************************
Глобальные функции
***************************************************************************************************/

/***************************************************************************************************
Описание: ПИД-регулятор
Аргументы: err - ошибка управления
Возврат: Величина управляющего сигнала
Замечания: 
***************************************************************************************************/

uint16_t control_run( int16_t err )
{
  uint16_t output;
  intTerm += kI*err;
  output = kP * err;
  output += intTerm;
  output += kD * (err - prevErr);

  prevErr = err;

  return output;
}
